<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global News Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use the 'Inter' font
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1e40af', // Blue 700
                        'secondary': '#f97316', // Orange 500
                        'accent': '#10b981', // Emerald 500
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
            background: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 0, 0.05);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1e40af; /* primary color */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Mobile adjustments for the news grid */
        @media (min-width: 640px) {
            #news-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            #news-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">


    <!-- Header and Controls -->
    <header class="text-center mb-10 p-6 bg-white rounded-2xl shadow-lg max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-primary mb-2">Global News Headlines</h1>
        <p class="text-gray-600 mb-6">Advanced Fetching Demonstrations</p>
       
        <!-- Fact of the Day (Multi-Endpoint Fetch) -->
        <div id="fact-container" class="p-3 bg-indigo-50 rounded-lg border border-indigo-200 mb-6 mx-auto max-w-lg">
            <!-- Fact will be injected here -->
        </div>


        <!-- Category Buttons (Conditional Fetch Logic) -->
        <div id="category-buttons" class="flex flex-wrap justify-center gap-3">
            <!-- Buttons will be generated by JS -->
        </div>
    </header>


    <!-- News Display Area (Loading/Error/Content) -->
    <main class="max-w-6xl mx-auto">
       
        <!-- Loading/Error State Container -->
        <div id="status-message" class="flex justify-center items-center py-10 min-h-64">
            <!-- Status messages and spinner will appear here -->
        </div>


        <!-- News Articles Grid -->
        <div id="news-grid" class="grid grid-cols-1 gap-6">
            <!-- News cards will be inserted here -->
        </div>


        <!-- Pagination/Load More Button -->
        <div id="pagination-container" class="flex justify-center mt-10">
            <button id="load-more-btn"
                    class="px-8 py-3 bg-secondary text-white font-bold rounded-full shadow-lg
                           hover:bg-orange-600 transition duration-150 ease-in-out">
                Load More Articles (Technology)
            </button>
        </div>


    </main>


    <script>
        // --- Global State and Constants ---
        const NEWS_API_BASE = 'https://saurav.tech/NewsAPI/top-headlines/category/';
        const FACT_API_URL = 'https://uselessfacts.jsph.pl/random.json?language=en'; // For Multi-Endpoint Fetch
        const COUNTRY_CODE = 'us';
        const CATEGORIES = ['general', 'business', 'technology', 'sports', 'health', 'science', 'entertainment'];
       
        // Caching and Real-Time Configuration
        const CACHE_LIFETIME = 5 * 60 * 1000; // 5 minutes for cache (Fetch from local cache)
        const BACKGROUND_REFRESH_RATE = 300000; // 5 minutes (Background data fetch)
        const SECONDARY_CATEGORY = 'technology'; // For Pagination Simulation


        // DOM Elements
        const statusMessageDiv = document.getElementById('status-message');
        const newsGrid = document.getElementById('news-grid');
        const categoryButtonsDiv = document.getElementById('category-buttons');
        const factContainer = document.getElementById('fact-container');
        const loadMoreBtn = document.getElementById('load-more-btn');


        // State variables
        let currentCategory = 'general';
        let backgroundFetchIntervalId = null;
        let hasLoadedMore = false;
       
        // --- Utility Functions ---


        /**
         * Renders articles to the grid, clearing it first if requested.
         * @param {Array<Object>} articles - Array of article objects.
         * @param {boolean} clearGrid - Whether to clear the grid before rendering.
         */
        function renderArticles(articles, clearGrid) {
            if (clearGrid) {
                newsGrid.innerHTML = '';
            }
            // Map data to HTML cards and insert into the DOM
            const newsHtml = articles.map(createNewsCard).join('');
           
            // Append or replace content
            if (clearGrid) {
                newsGrid.innerHTML = newsHtml;
            } else {
                newsGrid.insertAdjacentHTML('beforeend', newsHtml);
            }
        }


        /**
         * Clears the grid and displays a loading spinner.
         * @param {string} category - The category being loaded.
         */
        function showLoading(category) {
            newsGrid.innerHTML = '';
            statusMessageDiv.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-lg text-primary font-medium">Fetching ${category} headlines...</p>
                </div>
            `;
            // Reset Load More state when loading a new category
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'Load More Articles (Technology)';
            loadMoreBtn.classList.add('hover:bg-orange-600', 'bg-secondary');
            loadMoreBtn.classList.remove('opacity-50', 'bg-gray-400');
            hasLoadedMore = false;
        }


        /**
         * Displays an error message.
         * @param {string} message - The error message to show.
         */
        function showError(message) {
            newsGrid.innerHTML = '';
            statusMessageDiv.innerHTML = `
                <div class="text-center p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <p class="font-bold mb-2">Error Loading News</p>
                    <p class="text-sm">${message}</p>
                    <p class="text-xs mt-2">Please try again later or select a different category.</p>
                </div>
            `;
        }


        /**
         * Creates the HTML structure for a single news article card.
         */
        function createNewsCard(article) {
            const imageUrl = article.urlToImage && article.urlToImage !== 'null'
                ? article.urlToImage
                : `https://placehold.co/400x200/94a3b8/ffffff?text=No+Image`;
           
            const sourceName = article.source?.name || 'Unknown Source';
            const publishedDate = article.publishedAt
                ? new Date(article.publishedAt).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                  })
                : 'Date Unknown';


            const title = article.title || 'Untitled Article';
            const description = article.description || 'No description available for this article.';


            return `
                <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="card block h-full">
                    <article class="flex flex-col h-full">
                        <!-- Image Container -->
                        <div class="aspect-video overflow-hidden rounded-t-xl">
                            <img src="${imageUrl}" alt="${title}"
                                 class="w-full h-full object-cover"
                                 onerror="this.onerror=null;this.src='https://placehold.co/400x200/94a3b8/ffffff?text=No+Image';">
                        </div>
                       
                        <!-- Content -->
                        <div class="p-4 flex flex-col justify-between flex-grow">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 mb-2 leading-tight">${title}</h2>
                                <p class="text-gray-600 text-sm">${description}</p>
                            </div>
                           
                            <!-- Footer/Metadata -->
                            <div class="mt-4 pt-3 border-t border-gray-100 text-xs text-gray-500 flex justify-between">
                                <span class="font-medium text-accent">${sourceName}</span>
                                <span>${publishedDate}</span>
                            </div>
                        </div>
                    </article>
                </a>
            `;
        }
       
        // --- Fetch Functions ---


        /**
         * Sets up the periodic background data fetch for the current category.
         * (Background data fetch / Moderate real time data fetching)
         */
        function setupBackgroundRefresh(category) {
            if (backgroundFetchIntervalId) {
                clearInterval(backgroundFetchIntervalId);
            }
           
            backgroundFetchIntervalId = setInterval(() => {
                // Call silent fetch to check for new articles without interrupting the user
                fetchNewsSilent(category);
            }, BACKGROUND_REFRESH_RATE);
        }


        /**
         * Core function to fetch news, incorporating caching and background refresh setup.
         * @param {string} category - The news category to fetch.
         */
        async function fetchNews(category = 'general') {
            currentCategory = category;
           
            // 1. Check Local Cache (Fetch from local cache / Offline data fetch)
            const cacheKey = `news_cache_${category}`;
            const timestampKey = `news_timestamp_${category}`;
            const cachedData = localStorage.getItem(cacheKey);
            const cachedTimestamp = localStorage.getItem(timestampKey);
            const now = Date.now();


            if (cachedData && cachedTimestamp && (now - parseInt(cachedTimestamp) < CACHE_LIFETIME)) {
                // Cache is fresh, use it
                statusMessageDiv.innerHTML = '<p class="text-sm text-gray-500">Serving from 5-minute cache...</p>';
                const data = JSON.parse(cachedData);
                renderArticles(data.articles, true);
                console.log(`[Cache] Serving ${category} from local cache.`);
                setupBackgroundRefresh(category);
                return;
            }
           
            // 2. No Cache or Cache Expired: Show loading and fetch from API
            showLoading(category);
            const url = `${NEWS_API_BASE}${category}/${COUNTRY_CODE}.json`;


            try {
                const response = await fetch(url);


                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status} for category: ${category}`);
                }


                const data = await response.json();
               
                if (data.status === 'ok' && data.articles && data.articles.length > 0) {
                    // 3. Success: Cache the new data
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    localStorage.setItem(timestampKey, now.toString());


                    // 4. Render and setup background refresh
                    statusMessageDiv.innerHTML = '';
                    renderArticles(data.articles, true);
                    setupBackgroundRefresh(category);
                } else {
                    showError(`No articles found for the '${category}' category.`);
                }


            } catch (error) {
                console.error("Fetch Error:", error);
                showError(`A network or parsing error occurred: ${error.message}`);
            }
        }


        /**
         * A lighter version of fetchNews for background updates that doesn't clear the screen.
         */
        async function fetchNewsSilent(category) {
            const url = `${NEWS_API_BASE}${category}/${COUNTRY_CODE}.json`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP status ${response.status}`);
                const data = await response.json();
               
                if (data.status === 'ok' && data.articles && data.articles.length > 0) {
                    // Update cache silently
                    localStorage.setItem(`news_cache_${category}`, JSON.stringify(data));
                    localStorage.setItem(`news_timestamp_${category}`, Date.now().toString());


                    // Only re-render if the user is still on this category and hasn't loaded more content.
                    if (currentCategory === category && !hasLoadedMore) {
                        // Re-render the new articles, clearing the old ones (full refresh)
                        renderArticles(data.articles, true);
                        console.log(`[Background] ${category} news refreshed.`);
                        statusMessageDiv.innerHTML = '<p class="text-sm text-accent font-medium">Headlines updated!</p>';
                        setTimeout(() => statusMessageDiv.innerHTML = '', 3000); // Clear message after 3 seconds
                    }
                }
            } catch (error) {
                console.warn(`[Background Error] Could not refresh ${category}: ${error.message}`);
            }
        }
       
        /**
         * Fetches a random fact from a separate API endpoint.
         * (Fetch data from multiple endpoints)
         */
        async function fetchFact() {
            factContainer.innerHTML = '<span class="text-sm text-gray-500">Loading Fact...</span>';
            try {
                const response = await fetch(FACT_API_URL);
                if (!response.ok) throw new Error(`HTTP status ${response.status}`);
                const data = await response.json();
               
                // Dynamic content fetch and rendering
                factContainer.innerHTML = `
                    <p class="text-sm font-bold text-primary mb-1">Fact of the Day</p>
                    <p class="text-sm text-gray-700 italic">${data.text}</p>
                `;
            } catch (error) {
                console.error("Fact Fetch Error:", error);
                factContainer.innerHTML = '<span class="text-xs text-red-500">Could not load fact.</span>';
            }
        }


        /**
         * Simulates pagination by fetching a secondary category and appending results.
         * (Basic pagination support)
         */
        async function loadMoreNews() {
            if (hasLoadedMore) {
                // Using console.log instead of alert per instructions
                console.log("Additional articles already loaded.");
                return;
            }


            const originalText = loadMoreBtn.textContent;
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading More...';
            loadMoreBtn.classList.remove('hover:bg-orange-600', 'bg-secondary');
            loadMoreBtn.classList.add('opacity-50', 'bg-gray-400');


            // Fetch a distinct set of articles (SECONDARY_CATEGORY)
            const url = `${NEWS_API_BASE}${SECONDARY_CATEGORY}/${COUNTRY_CODE}.json`;


            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP status ${response.status}`);
                const data = await response.json();


                if (data.status === 'ok' && data.articles && data.articles.length > 0) {
                    // Append the new articles to the existing grid
                    renderArticles(data.articles, false);
                   
                    hasLoadedMore = true;
                    loadMoreBtn.textContent = `Successfully Loaded ${data.articles.length} Technology Articles!`;
                    loadMoreBtn.classList.add('bg-accent');
                } else {
                    loadMoreBtn.textContent = 'No more articles available.';
                }
            } catch (error) {
                console.error("Load More Error:", error);
                loadMoreBtn.textContent = 'Error loading articles.';
            }
            loadMoreBtn.classList.remove('opacity-50');
            loadMoreBtn.classList.remove('hover:bg-orange-600');
            loadMoreBtn.classList.remove('bg-secondary');
            loadMoreBtn.disabled = true;
        }


        // --- Initialization and Event Handling ---


        /**
         * Initializes the category buttons and sets up event listeners.
         */
        function setupCategories() {
            categoryButtonsDiv.innerHTML = CATEGORIES.map(cat => `
                <button data-category="${cat}"
                        class="category-btn px-4 py-2 font-semibold text-sm rounded-full shadow-md
                               bg-white text-gray-700 hover:bg-primary hover:text-white
                               transition duration-150 ease-in-out uppercase tracking-wider">
                    ${cat}
                </button>
            `).join('');


            // Add event listener to the parent container for delegation
            categoryButtonsDiv.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('category-btn')) {
                    const category = target.dataset.category;
                   
                    // Conditional Fetch Logic: Stop current background refresh and reset pagination flag
                    clearInterval(backgroundFetchIntervalId);
                   
                    // Update active button styling
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('bg-white', 'text-gray-700');
                    });
                    target.classList.add('bg-primary', 'text-white');


                    // Trigger the fetch call
                    fetchNews(category);
                }
            });
        }


        // Run setup and initial fetch on page load
        window.onload = function() {
            setupCategories();
           
            // Set initial active button style
            const initialButton = document.querySelector(`.category-btn[data-category="general"]`);
            if (initialButton) {
                initialButton.classList.add('bg-primary', 'text-white');
            }
           
            // Fetch news and fact concurrently (Fetch data from multiple endpoints)
            Promise.all([
                fetchNews('general'),
                fetchFact()
            ]).catch(err => console.error("Initial load sequence failed:", err));


            // Event listener for Load More
            loadMoreBtn.addEventListener('click', loadMoreNews);
        };


    </script>
</body>
</html>
